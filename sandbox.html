<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>UserWeb Sandbox</title>
</head>
<body>
  <script>
    // Sandbox page for loading scripts/styles with relaxed CSP
    // This page can load blob URLs without CSP restrictions
    
    // Listen for messages from the extension
    window.addEventListener('message', async function(event) {
      // Only accept messages from our extension
      if (event.data.type === 'LOAD_SCRIPT' && event.data.code) {
        try {
          // Create blob URL in sandbox context (this works because we're in sandbox)
          const blob = new Blob([event.data.code], { type: 'application/javascript' });
          const blobUrl = URL.createObjectURL(blob);
          
          // Load script from blob URL
          const script = document.createElement('script');
          script.src = blobUrl;
          script.type = 'text/javascript';
          
          script.onload = () => {
            // Notify parent that script loaded
            if (window.parent) {
              window.parent.postMessage({
                type: 'SCRIPT_LOADED',
                success: true,
                id: event.data.id
              }, '*');
            }
            // Clean up blob URL
            URL.revokeObjectURL(blobUrl);
          };
          
          script.onerror = (error) => {
            console.error('Error loading script in sandbox:', error);
            if (window.parent) {
              window.parent.postMessage({
                type: 'SCRIPT_LOADED',
                success: false,
                id: event.data.id,
                error: 'Failed to load script'
              }, '*');
            }
            URL.revokeObjectURL(blobUrl);
          };
          
          document.head.appendChild(script);
        } catch (error) {
          console.error('Error in sandbox script loading:', error);
          if (window.parent) {
            window.parent.postMessage({
              type: 'SCRIPT_LOADED',
              success: false,
              id: event.data.id,
              error: error.message
            }, '*');
          }
        }
      } else if (event.data.type === 'LOAD_STYLE' && event.data.code) {
        try {
          // Create blob URL in sandbox context
          const blob = new Blob([event.data.code], { type: 'text/css' });
          const blobUrl = URL.createObjectURL(blob);
          
          // Load CSS from blob URL
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.type = 'text/css';
          link.href = blobUrl;
          
          link.onload = () => {
            if (window.parent) {
              window.parent.postMessage({
                type: 'STYLE_LOADED',
                success: true,
                id: event.data.id
              }, '*');
            }
            URL.revokeObjectURL(blobUrl);
          };
          
          link.onerror = (error) => {
            console.error('Error loading style in sandbox:', error);
            if (window.parent) {
              window.parent.postMessage({
                type: 'STYLE_LOADED',
                success: false,
                id: event.data.id,
                error: 'Failed to load style'
              }, '*');
            }
            URL.revokeObjectURL(blobUrl);
          };
          
          document.head.appendChild(link);
        } catch (error) {
          console.error('Error in sandbox style loading:', error);
          if (window.parent) {
            window.parent.postMessage({
              type: 'STYLE_LOADED',
              success: false,
              id: event.data.id,
              error: error.message
            }, '*');
          }
        }
      }
    });
    
    // Notify parent that sandbox is ready
    if (window.parent) {
      window.parent.postMessage({
        type: 'SANDBOX_READY'
      }, '*');
    }
  </script>
</body>
</html>
